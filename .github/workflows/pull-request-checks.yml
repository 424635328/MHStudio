# .github/workflows/pull-request-checks.yml
# 最终正确版：使用“看门人”任务，只为自动化 PR 运行质量检查

name: 'Pull Request Checks'

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  check-labels:
    name: Check PR Labels
    runs-on: ubuntu-latest
    # 将输出权限赋予这个任务，以便它可以设置一个输出值（虽然本例中没用到，但这是个好习惯）
    permissions:
      contents: read
    outputs:
      # 可以定义一个输出，供后续任务使用（可选）
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      # 这个任务的核心就是这个 if 条件
      - id: check
        # 只有当 PR 包含 'automated-pr' 标签时，这个步骤（以及整个任务）才会成功运行
        if: contains(github.event.pull_request.labels.*.name, 'automated-pr')
        run: |
          echo "PR has the 'automated-pr' label. Proceeding with checks."
          echo "should_run=true" >> $GITHUB_OUTPUT
      # 如果 if 条件不满足，上面的步骤会被跳过，任务会以“成功”状态结束，但后续依赖它的任务会因为上下文不满足而被跳过。

  # 任务一：代码规范和基础检查
  lint:
    name: Code Linter
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # 👇 核心修改 2: 让这个任务依赖于 'check-labels' 任务
    needs: check-labels
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Run linter
        run: npm run lint

  # 任务二：运行测试
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # 👇 核心修改 2: 让这个任务也依赖于 'check-labels' 任务
    needs: check-labels
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Run tests
        run: npm test

  # 任务三：运行构建
  build:
    name: Verify Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # 这个任务现在依赖于 lint 和 test
    # 而 lint 和 test 都依赖于 check-labels，所以依赖链是正确的
    needs: [lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Build project
        run: npm run build

  # 任务四：最终状态汇总
  all-checks-passed:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [build] # 依赖于最终的 build 任务
    permissions: {}
    steps:
      - name: Signal successful completion
        run: echo "✅ All quality checks for the automated PR have passed successfully!"